# 今日のTODO調査・分析

作成日: 2025年10月24日

---

## 📋 TODO一覧

### 優先度高

#### 1. **スコア計算対象のおりたたみ** ⭐⭐⭐
- **内容**: 優先度高、スコア計算対象折り畳み時は、選択中のものをステータスアイコンで表示する
- **現在の実装状態**:
  - `ReliquaryDetailScreen`で「スコア計算対象」UIを展開状態で表示中
  - `_buildScoreTargetSelection()`がCheckboxで実装されている
- **実装予定**:
  - 折り畳み/展開切り替え機能を追加
  - 折り畳み時は選択中のステータスをアイコンで表示
  - Wrapレイアウトでコンパクト表示
- **技術検討**:
  - アイコン: Material Designのアイコンまたはカスタム画像
  - 色分け: 各ステータスごとに色を分ける（会心率=赤、元素チャージ効率=紫など）
  - アニメーション: 展開/折り畳み時にスムーズなアニメーション

---

#### 2. **詳細画面、タブ遷移しても再構築シミュレーションが初期化されないようにする** ⭐⭐⭐
- **内容**: タブ切り替え時に再構築シミュレーター画面の入力内容を保持
- **現在の実装状態**:
  ```dart
  RebuildSimulatorView(
    key: ValueKey(_scoreTargetChangeNotifier.value),  // ← スコア計算対象変更時に再初期化されている
    ...
  )
  ```
  - ValueKeyで管理されているため、`_scoreTargetChangeNotifier`が更新されると再生成される
  - タブ遷移もWidgetが再生成される可能性あり

- **問題**:
  - スコア計算対象を変更すると、再構築シミュレーターの入力（サブオプション選択、再構築種別選択）が初期化される
  - これはユーザーの入力体験を損なっている

- **解決方針**:
  1. **RebuildSimulatorViewの状態を外部管理に変更**
     - 詳細画面（親）で状態を保持
     - RebuildSimulatorViewは純粋なViewとして機能

  2. **ValueKeyを削除またはstableなKeyに変更**
     - `ValueKey(_scoreTargetChangeNotifier.value)`ではなく、`ObjectKey(widget.summary)`など

  3. **再構築結果の再計算は必要かチェック**
     - スコア計算対象変更時は、結果のスコアは変わるため再計算が必要
     - ただし、入力フィールドは保持できるはず

- **実装方法**:
  ```dart
  // 詳細画面に状態管理を移行
  late final _rebuildSimulatorKey = ObjectKey(widget.summary);
  
  // または、RebuildSimulatorViewをStatelessWidgetに変更して、
  // 状態を詳細画面で管理
  ```

---

#### 3. **再構築シミュレーションのカード順番調整** ⭐⭐
- **内容**: 操作するカードは常に最上部に表示する
- **現在の実装状態**:
  ```dart
  // rebuild_simulator_view.dart
  if (_selectedRebuildType != null && _isRebuildTypeCollapsed) ...[
    _buildSimulationCard(),
    // ↓ さらに下に表示
    if (_simulationTrial != null) _buildSimulationResult(),
  ]
  ```

- **実装予定**:
  1. シミュレーション実行ボタンのあるカード（操作用）
  2. シミュレーション結果

  の順で、常に操作用カードが上に来るようにする

- **技術検討**:
  - ListView.separatedで複数カードを管理
  - またはColumnで順序を調整

---

### 優先度中

#### 4. **スコア計算対象変更時、再構築シミュレーションの状態維持**
- **内容**: スコア計算対象を変更しても、サブオプション選択や再構築種別選択を保持する
- **現在**: スコア計算対象変更時に画面が再初期化される
- **調査必要**: 
  - 状態保持は技術的に可能か
  - 結果の再計算ロジックとの兼ね合い
  - 新しいスコア計算結果は自動更新するべきか

- **実装予定**:
  1. 状態の分離: 入力値 vs 計算結果
  2. スコア計算対象変更時は、計算結果のみ更新、入力は保持
  3. スコア差分や改善判定も再計算

---

#### 5. **デスクトップなど横幅が広い画面ではカード幅を狭くする**
- **内容**: max幅指定でレスポンシブ対応
- **実装予定**:
  ```dart
  Container(
    constraints: const BoxConstraints(maxWidth: 600),  // デスクトップ時
    child: SingleChildScrollView(...),
  )
  ```

- **検討項目**:
  - マックス幅の値（500～700px程度か）
  - ブレークポイント（MediaQuery.of(context).size.width）

---

#### 6. **再構築シミュレーション結果の枠外余白がちょっと広いかも**
- **内容**: モバイルから見た時、横幅が狭い気がする
- **現在**:
  ```dart
  SingleChildScrollView(
    padding: const EdgeInsets.all(16.0),  // ← 16の余白
    ...
  )
  ```

- **実装予定**:
  - 余白を12以下に減らす
  - またはレスポンシブで調整（モバイルは16、デスクトップは24など）

---

#### 7. **再構築シミュレーション結果にも聖遺物アイコンとメインステータスの表記が欲しい**
- **内容**: リッチなUIに（フォントや文字サイズは変更しない）
- **現在**: `_buildSimulationResult()` → `_buildSubstatsList()` でシンプルなテキスト表示
- **実装予定**:
  1. 聖遺物アイコン（部位別）
  2. メインステータス表示（例: "攻撃力+300"）
  3. 配置: 「新しいサブステータス」の上に表示
  4. デザイン: `ReliquarySummaryView`と同様のスタイル

- **技術**:
  - `artifact_icon_resolver`を使用
  - `ReliquarySummary`から部位情報を取得

---

#### 8. **トップページに簡単な説明を追加する**
- **内容**: アプリの使い方を簡潔に説明
- **提案内容**:
  ```
  聖遺物の初期値など詳細情報を確認
  再構築シミュレーターで最適な聖啓の塵の投資先を選択
  ```

- **実装予定**:
  - ホーム画面の上部に説明パネルを追加
  - 非表示にできる（永遠に非表示 or 一時的）
  - デザイン: Material Designのカード

---

#### 9. **更新率の精度について注意文の追加**
- **内容**: ヘルプボタンなど用意して、精度についての注意文を表示
- **提案内容**:
  ```
  ※この結果はモンテカルロ法(N=200k)によるシミュレーションを用いており、
  わずかな誤差(平均±0.22%)を含む場合があります。
  ```

- **実装予定**:
  1. `_buildSimulationResult()`のスコア表示エリアにHelpボタンを追加
  2. タップするとダイアログ表示
  3. または、小さい「?」アイコンをTooltipで対応

---

### 優先度低（拡張機能）

#### 10. **再構築シミュレーションのアニメーション追加Ⅰ**
- **内容**: 再構築実行時に即結果を表示せず、0.5～0.8秒ほどロードさせる
- **実装予定**:
  ```dart
  _executeSimulation() async {
    _isCalculating = true;  // ローディング開始
    setState(() {});
    
    await Future.delayed(const Duration(milliseconds: 600));  // ローディング時間
    
    // 結果を計算・表示
    _simulationTrial = trial;
    _isCalculating = false;
    setState(() {});
  }
  ```

- **UX効果**: 計算中感を演出、次のアニメーションへの準備

---

#### 11. **再構築シミュレーションのアニメーション追加Ⅱ**
- **内容**: ゲーム内に寄せる。0.5秒間隔で一つずつオプションを抽選していく
- **実装予定**:
  1. 結果データを先に計算しておく
  2. UIには最初「??」を表示
  3. 0.5秒ごとに1つずつサブオプションを更新していく
  4. アニメーション後に最終結果を表示

- **UX効果**: ゲーム感覚、ドキドキ感の演出

---

## 🐛 バグ報告

### **再構築シミュレーター実行時、最低保証回数が等回数分配される**

- **症状**: 
  - 絶対再構築（最低保証4回）を実行すると、選択サブオプションA/Bが必ず2回ずつ伸びている
  - 本来は、A/B に偏りがあるはずなのに、完全に均等配分されている

- **原因分析**:
  ```dart
  // rebuild_simulator_service.dart, line 368-375
  
  // 7. 希望サブオプション（primary + secondary）に最低保証回数を割り当て
  final guaranteedEnhancements = <String>[];
  // primaryに優先的に割り当て
  for (int i = 0; i < forcedCount && i < remainingEnhancements; i++) {
    if (i % 2 == 0) {
      guaranteedEnhancements.add(primarySubstat.propId);
    } else {
      guaranteedEnhancements.add(secondarySubstat.propId);
    }
  }
  ```

  **問題**: このコードは「保証回数を primary/secondary に交互に割り当てている」
  - `forcedCount = 4`の場合: `[Primary, Secondary, Primary, Secondary]`
  - 必ず2回ずつになってしまう
  
  **本来の仕様**:
  - 保証回数の内訳は「ランダム」であるべき
  - 例: `[Primary, Primary, Primary, Secondary]` や `[Secondary, Primary, Secondary, Primary]` など
  - つまり、4回の保証は「どちらか一方に集中することもあれば、均等もある」ということ

- **修正方法**:
  ```dart
  // 改善案1: ランダムに保証回数を分配
  final guaranteedEnhancements = <String>[];
  for (int i = 0; i < forcedCount && i < remainingEnhancements; i++) {
    final selected = random.nextBool() ? primarySubstat.propId : secondarySubstat.propId;
    guaranteedEnhancements.add(selected);
  }
  
  // 改善案2: 最初は保証として「どちらかを指定」、あとはランダム
  // (現在の「交互」ロジックを削除)
  ```

- **検証方法**:
  1. 同じ聖遺物で絶対再構築を10回実行
  2. A/Bの強化回数の分配を観察
  3. 2:2 ばかり出ていたら、バグ確定
  4. 3:1, 1:3, 2:2 などの分配が出ていたら、バグ修正成功

- **優先度**: 🔴 高 - ゲームの再現性に影響

---

## 📊 実装順序の提案

### フェーズ1（即対応）
1. **バグ修正**: 最低保証回数の均等分配バグ
2. **TODO 2**: 再構築シミュレーションの状態保持（タブ遷移時）

### フェーズ2（UI/UX改善）
3. **TODO 1**: スコア計算対象の折り畳み機能
4. **TODO 3**: カード順番調整
5. **TODO 7**: 結果にアイコン・メインステータス表記追加

### フェーズ3（拡張・チューニング）
6. **TODO 6**: 余白調整（モバイル→デスクトップ）
7. **TODO 5**: 横幅広い画面での対応
8. **TODO 8**: トップページ説明追加
9. **TODO 9**: 精度注釈の追加

### フェーズ4（アニメーション）
10. **TODO 10, 11**: アニメーション追加（ローディング、抽選風味）

---

## 🔧 技術的な検討点

| 項目 | 検討内容 | 判断 |
|------|---------|------|
| 状態管理 | RebuildSimulatorViewの状態を外部管理か内部管理か | 外部管理推奨（詳細画面で管理） |
| キー管理 | ValueKeyの使用方法 | ObjectKey(summary)へ変更検討 |
| パフォーマンス | 再計算の頻度 | スコア計算対象変更時のみ再計算 |
| アイコン表示 | ステータスアイコンの実装方法 | Material + カスタムアイコン |
| レスポンシブ | ブレークポイント | 600px を基準に検討 |
| アニメーション | 抽選風味の実装方法 | Streambuilderまたはアニメーション結果の遅延表示 |

---

## ✅ 完了チェックリスト

- [x] バグ修正: 最低保証回数
- [ ] タブ遷移時の状態保持
- [x] スコア計算対象の折り畳み
- [ ] カード順番調整
- [ ] 結果表示のリッチ化（アイコン+メインステ）
- [ ] 横幅調整
- [ ] トップページ説明追加
- [ ] 精度注釈
- [ ] ローディングアニメーション
- [ ] 抽選風アニメーション

