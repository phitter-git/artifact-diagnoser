# 聖遺物診断機 ロードマップ

## 📌 プロジェクト概要

Genshin Impact の聖遺物を詳細に分析し、最適化をサポートするFlutterアプリケーション。
ユーザーのUID から聖遺物データを取得し、スコアリング、強化履歴、再構築提案などの高度な分析機能を提供します。

---

## 🎯 Ver 1.0 リリース目標

初回リリースでは、聖遺物の分析に必要なコア機能を実装し、ユーザーが自分の聖遺物を詳細に把握できる状態を目指します。

**リリース予定日:** TBD  
**対象プラットフォーム:** Web（将来的にモバイル対応）

---

## 🚀 Phase 1: コア機能（必須）

基本的な聖遺物の読み込みと分析機能を実装します。

### 1.1 UIDから聖遺物情報の読み込み ✅
**Status:** 実装済み  
**優先度:** 🔴 最高

- [x] ユーザーIDの入力UI
- [x] REST API経由でのデータ取得
- [x] 聖遺物データのパース（remote → domain変換）
- [x] エラーハンドリング（UID不正、通信エラー）

**関連ドキュメント:** [features.md#uid読み込み](./requirements/features.md)

---

### 1.2 聖遺物のサブオプション詳細情報分析 ✅
**Status:** 実装済み  
**優先度:** 🔴 最高

- [x] サブオプションの強化履歴分析（+0/+4/+8/+12/+16/+20）
- [x] どのサブステータスがいつ強化されたか判定
- [x] 各強化段階での数値を表示
- [x] UI実装：強化段階の切り替え（タブ）
- [x] 増加値の表示（アイコン付き、Tier別色分け）
- [x] サブステータスランクバッジ（S/A/B/C）の表示

**関連ドキュメント:** [features.md#サブオプション分析](./requirements/features.md)

---

### 1.3 聖遺物の初期値表示 ✅
**Status:** 実装済み  
**優先度:** 🟠 高

聖遺物を取得した時点（初期状態）のサブオプションを表示します。

**タスク詳細:**
- [x] 初期サブオプション数の判定ロジック
  - サブオプション3つ → +4の状態を初期値とする
  - サブオプション4つ → +0の状態を初期値とする
- [x] 初期値表示UIコンポーネント
  - 初期値と現在値の比較表示
  - 初期値の強調表示（Tier別ランクバッジ）
  - 一覧画面での初期値表示切り替え機能

**技術仕様:**
```dart
class ReliquarySummary {
  final int initialLevel; // 0 or 4
  final int displayLevel; // 現在の強化レベル
  final List<SubstatSummary> substats; // 各サブステータス
}
```

**依存関係:** 1.2（サブオプション分析）

---

### 1.4 聖遺物のスコアリング（基本版） ✅
**Status:** 実装済み  
**優先度:** 🟠 高

ユーザーが選択したステータスに基づいて聖遺物のスコアを計算します。

**タスク詳細:**
- [x] スコア計算ロジックの実装（ReliquaryCardView内）
  - [x] 基本スコア計算式
    - 会心率: `n% × 2`
    - 会心ダメージ: `n%`
    - 攻撃力%: `n%`
    - 防御力%: `n%`
    - HP%: `n%`
    - 元素熟知: `n / 4`
    - 元素チャージ効率: `n%`
  - [x] ユーザー選択可能なステータスのモデル化（Map<String, bool>）
  - [x] リアルタイムスコア計算
  
- [x] スコア表示UIコンポーネント
  - [x] 総合スコア表示（カード下部に配置）
  - [x] ステータス選択UI（チェックボックス、会心率/会心ダメージデフォルト選択）
  - [x] スコアベースランク評価（SS/S/A/B/C）
  - [x] 選択中のステータスの視覚的フィードバック（塗りつぶし円マーカー）
  - [x] 部位別ランク基準の自動適用（花羽（基本）、砂/杯（-5.0）、冠（-10.0））
  - [x] 半透明ウォーターマークでのランク表示

**計算例:**
```
会心率: 7.8%
会心ダメージ: 20.2%
攻撃力%: 9.9%
防御力%: 6.5%

選択: 会心率 + 会心ダメージ + 攻撃力%
計算: (7.8 × 2) + 20.2 + 9.9 = 45.7
ランク: S（花の基準: 45.0-49.9）
```

**関連ドキュメント:** [scoring_logic.md](./requirements/scoring_logic.md)

**依存関係:** 1.2（サブオプション分析）

---

## 🔬 Phase 2: 分析機能（重要）

Phase 1の基盤の上に、より高度な分析機能を追加します。

### 2.1 聖遺物の理論値計算
**Status:** 未実装  
**優先度:** 🟡 中

現在の聖遺物が理想的に強化された場合の最大スコアを計算します。

**タスク詳細:**
- [ ] 理論値計算ロジック
  - [ ] 初期値からの残り強化回数を計算
  - [ ] 選択中のステータスで最大値強化を仮定
  - [ ] 最大スコアを算出
  
- [ ] 理論値表示UI
  - [ ] 現在スコアと理論値の比較
  - [ ] 達成率の表示（現在スコア / 理論値 × 100%）
  - [ ] プログレスバーやグラフでの視覚化

**計算ロジック:**
```
残り強化回数 = (20 - 現在レベル) / 4
理論値 = 現在スコア + (最大強化値 × 残り強化回数)
達成率 = 現在スコア / 理論値 × 100
```

**依存関係:** 1.4（スコアリング）

---

### 2.2 聖遺物の再構築更新率の計算
**Status:** 未実装  
**優先度:** 🟡 中

再構築を行った場合に、現在より良い聖遺物になる確率を計算します。

**タスク詳細:**
- [ ] 再構築確率計算アルゴリズム
  - [ ] 各サブステータスの出現確率
  - [ ] 強化値の確率分布（4段階）
  - [ ] モンテカルロシミュレーション（必要に応じて）
  
- [ ] 再構築タイプ別の計算
  - 再構築（通常）：最低保証2回
  - 上級再構築：最低保証3回
  - 絶対再構築：最低保証4回
  
- [ ] 更新率表示UI
  - [ ] 各再構築タイプの更新確率
  - [ ] 期待値スコアの表示
  - [ ] リスク/リターンの視覚化

**技術的な懸念:**
- 確率計算が複雑（組み合わせ爆発の可能性）
- アルゴリズムの事前設計が必要
- パフォーマンス最適化（Web Workerの検討）

**依存関係:** 1.4（スコアリング）

---

### 2.3 聖遺物の再構築シミュレーター
**Status:** 未実装  
**優先度:** 🟡 中

希望するサブオプションを選択し、再構築の結果をシミュレーションします。

**タスク詳細:**
- [ ] シミュレーション実行ロジック
  - [ ] 希望サブオプション2種の選択UI
  - [ ] 初期サブオプション数（3つ/4つ）に応じた振り直し回数の計算
  - [ ] 最低保証システムの実装
  - [ ] 抽選値のランダム生成（4段階：最小/中低/中高/最大）
  
- [ ] 再構築タイプの選択
  - [ ] 通常再構築（保証2回）
  - [ ] 上級再構築（保証3回）
  - [ ] 絶対再構築（保証4回）
  
- [ ] シミュレーション結果表示UI
  - [ ] 強化段階ごとの結果表示（+0/+4/+8/+12/+16/+20）
  - [ ] 各段階で強化されたサブステータスのハイライト
  - [ ] 最終スコアの表示と現在スコアとの比較
  - [ ] 「再シミュレーション」ボタン
  - [ ] シミュレーション履歴（最新N件）

**UI/UX要件:**
```
┌─────────────────────────────────┐
│  再構築シミュレーター              │
├─────────────────────────────────┤
│  希望サブオプションを選択          │
│  ☑ 会心率                        │
│  ☑ 会心ダメージ                  │
│  ☐ 攻撃力%                       │
│  ☐ 防御力%                       │
│                                 │
│  再構築タイプ                     │
│  ◉ 通常再構築（保証2回）          │
│  ○ 上級再構築（保証3回）          │
│  ○ 絶対再構築（保証4回）          │
│                                 │
│  [シミュレーション実行]            │
│                                 │
│  ──────────────────────          │
│  結果                            │
│  現在: 45.7 → 結果: 52.3 (+6.6)  │
│                                 │
│  強化履歴                         │
│  +4:  会心ダメージ +7.8%         │
│  +8:  会心率 +3.9%               │
│  +12: 攻撃力% +5.8%              │
│  +16: 会心ダメージ +6.2%         │
│  +20: 会心率 +3.5%               │
│                                 │
│  [再シミュレーション] [結果を保存] │
└─────────────────────────────────┘
```

**機能詳細:**
- 複数回シミュレーションを実行し、統計情報を表示（平均スコア、最高/最低スコア）
- シミュレーション結果の保存・比較機能
- 「X回シミュレーション」で一括実行し、成功率を算出

**依存関係:** 1.4（スコアリング）、2.2（再構築更新率計算）

---

### 2.4 聖遺物のスコアリング（詳細版：部位別ランク付け） ✅
**Status:** 実装済み  
**優先度:** 🟡 中

同一部位の聖遺物を比較し、ランク付けを行います。

**タスク詳細:**
      - [x] 部位別スコア比較ロジック
        - [x] 同一部位（花/羽/時計/杯/冠）でのスコア評価
        - [x] 部位別閾値の自動適用（花羽（基本）、砂/杯（-5.0）、冠（-10.0））
        - [x] ランク判定アルゴリズム（SS/S/A/B/C）
  
- [x] ランク表示UI
  - [x] ランクバッジの表示（一覧・詳細両方）
  - [x] 部位別基準での自動判定
  - [x] ランク別の色分け（S=#FF8C00, A=#A256E1, B=#4A90E2, C=#73C990）
  - [x] 一覧画面でのウォーターマークランク表示（半透明、縁取り付き）
  - [x] 詳細画面での増加値個別ランク表示

**ランク基準:**
```
基本基準（花・羽・杯）:
  SS: 50.0+
  S:  45.0-49.9
  A:  40.0-44.9
  B:  30.0-39.9
  C:  ~29.9

砂の基準（5.0寛容）:
  SS: 45.0+
  S:  40.0-44.9
  A:  35.0-39.9
  B:  25.0-34.9
  C:  ~24.9

冠の基準（10.0寛容）:
  SS: 40.0+
  S:  35.0-39.9
  A:  30.0-34.9
  B:  20.0-29.9
  C:  ~19.9
```

**依存関係:** 1.4（スコアリング）

---

## 🌟 Phase 3: 高度な機能（拡張）

ユーザー体験をさらに向上させる高度な機能を追加します。

### 3.1 聖遺物の再構築更新率の比較
**Status:** 未実装  
**優先度:** 🟢 低

所持している聖遺物の中で、どれを再構築すべきか推奨します。

**タスク詳細:**
- [ ] 優先度計算アルゴリズム
  - [ ] 更新率の高い聖遺物を抽出
  - [ ] 現在スコアの低い聖遺物を考慮
  - [ ] 部位のバランスを考慮
  
- [ ] 推奨リストUI
  - [ ] 再構築候補の一覧表示
  - [ ] 理由の説明（なぜこの聖遺物を推奨するか）
  - [ ] ソート機能（更新率順/スコア順）

**依存関係:** 2.2（再構築更新率計算）、2.3（再構築シミュレーター）

---

### 3.2 聖遺物の所持データの随時保存
**Status:** 未実装  
**優先度:** 🟢 低

ユーザーの聖遺物データをローカルに保存し、再訪問時に読み込みます。

**タスク詳細:**
- [ ] データ保存機能
  - [ ] LocalStorage/IndexedDBへの保存
  - [ ] データの圧縮（容量削減）
  - [ ] 自動保存のトリガー設定
  
- [ ] インポート/エクスポート機能
  - [ ] JSON形式でのエクスポート
  - [ ] ファイルからのインポート
  - [ ] データバリデーション
  
- [ ] データ管理UI
  - [ ] 保存データの一覧
  - [ ] 削除/復元機能
  - [ ] データサイズの表示

**技術選択:**
- Phase 1: LocalStorage（シンプル、サイズ制限5-10MB）
- Phase 2: IndexedDB（大容量対応）
- 将来: Googleログインとクラウド同期

**技術的な懸念:**
- LocalStorageの容量制限（特に聖遺物200個以上）
- プライバシー対応（GDPR等）
- データマイグレーション（バージョン管理）

**依存関係:** なし（独立機能）

---

## 📊 進捗トラッキング

### 全体進捗

```
Phase 1 (コア機能):     ████████████████ 100% (4/4)
Phase 2 (分析機能):     ████░░░░░░░░░░░░  25% (1/4)
Phase 3 (高度な機能):   ░░░░░░░░░░░░░░░░   0% (0/2)
────────────────────────────────────────
全体:                   █████░░░░░░░░░░░  50% (5/10)
```

### 最新の完了項目

- ✅ 2025-10-13: 聖遺物詳細画面のUI改善（一覧と統一）
- ✅ 2025-10-13: サブステータス個別ランクバッジ表示
 - ✅ 2025-10-13: 部位別ランク付け（スコアベース評価、杯を砂と同グループへ移動）
- ✅ 2025-10-13: 聖遺物のスコアリング（基本版 + UI）
- ✅ 2025-10-13: 聖遺物の初期値表示

### 次のマイルストーン

- 🎯 **Next:** 聖遺物の理論値計算（Phase 2.1）
- 🎯 **After:** 再構築更新率の計算（Phase 2.2）

---

## 🔗 関連ドキュメント

- [機能詳細仕様](./requirements/features.md)
- [スコアリングロジック](./requirements/scoring_logic.md)
- [UI設計方針](./requirements/ui_design.md)
- [技術仕様](./requirements/technical_specs.md)

---

## 📝 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-10-12 | 初版作成、Phase 1-3の定義 |
| 2025-10-12 | Phase 2に「再構築シミュレーター」機能を追加 |
| 2025-10-12 | 部位別ランク基準を詳細化（花・羽・杯、砂、冠） |
| 2025-10-13 | Phase 1完了、Phase 2.4完了に更新 |
| 2025-10-13 | UI改善（1.5倍拡大、統一レイアウト）を反映 |
