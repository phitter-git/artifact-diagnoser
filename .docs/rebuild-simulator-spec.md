# 再構築シミュレーター機能 詳細仕様書

**作成日**: 2025年10月22日  
**バージョン**: 1.0  
**ステータス**: 設計完了

---

## 📋 概要

ユーザーが希望する2つのサブステータスを選択し、選択した再構築種別（通常/上級/絶対）で聖遺物を再構築した場合の理論最大値と更新率を計算・表示する機能。

---

## 🎯 機能要件

### 1. サブステータス選択

**表示対象**: 現在の聖遺物が+20時点で持っている4つのサブステータスのみ

**選択制約**:
- 必ず2つ選択（1つまたは3つ以上は不可）
- ラジオボタン風の表示（`○ 会心率` / `● 会心率`）
- デフォルト選択なし（ユーザーが明示的に選択）

**UI例**:
```
希望サブオプションを選択（2つ選択必須）
● 会心率
● 会心ダメージ
○ 攻撃力%
○ 元素チャージ効率
```

---

### 2. 再構築種別選択

**選択肢**:
- ◉ 通常再構築（保証2回）
- ○ 上級再構築（保証3回）
- ○ 絶対再構築（保証4回）

**デフォルト**: 通常再構築

**動作**:
- ラジオボタンで単一選択
- 選択変更時に自動で更新率を再計算

---

### 3. スコア計算対象の選択

**目的**: 更新率計算時に、どのサブステータスをスコア対象に含めるかを選択

**UI**:
```
スコア計算対象を選択
☑ 会心率
☑ 会心ダメージ
☐ 攻撃力%
☐ 元素チャージ効率
```

**動作**:
- 一覧画面と同様のチェックボックス形式
- デフォルト: 会心率・会心ダメージのみ選択
- 最低1つは選択必須
- 選択変更時に現在スコア・理論スコア・更新率を再計算

**スコア係数**:
```dart
スコア係数:
- 会心率: ×2
- 会心ダメージ: ×1
- 攻撃力%: ×1  ← 重要: 1.0（0.67ではない）
- 防御力%: ×1
- HP%: ×1
- 元素熟知: ×0.25
- 元素チャージ効率: ×1
```

---

### 4. 現在の状態表示

選択した2つのサブステータスと、スコア計算対象に選択されたサブステータスについて表示。

**表示項目**:
```
現在の状態（再構築前）
• 会心率: 7.0% (×2回強化)
• 会心ダメージ: 28.0% (×4回強化)
• 攻撃力%: 15.2% (×3回強化) ※グレー表示
• 元素チャージ効率: 11.0% (×2回強化) ※グレー表示

スコア対象合計: 42.0
  (会心率 7.0×2 + 会心ダメージ 28.0×1)
```

**計算式**:
```dart
現在スコア = Σ(スコア対象に選択された各サブステの現在値 × スコア係数)
```

**注意**:
- 選択した2つのサブステは常に表示（太字）
- スコア対象に選択されていないサブステはグレー表示
- スコア計算には、スコア対象チェックボックスで選択されたもののみ使用

---

### 5. 理論最大値表示

**定義**: 選択した2つのサブステータスのうち、**優先度の高い方を残り全回数強化**した場合の値（再構築により×1状態にリセット後）

**優先度順位**:
```
会心率% > 会心ダメージ% > 防御力% > 元素チャージ効率% > 攻撃力% > HP% > 元素熟知
```

**計算ロジック**:
```dart
// 1. 残りの強化回数を計算
// 初期4: +0から5回強化（+4, +8, +12, +16, +20）
// 初期3: +4から4回強化（+8, +12, +16, +20）※+4で1つ追加済み
残り強化回数 = (初期サブステ数 == 4) ? 5 : 4

// 2. 選択した2つのサブステのうち、優先度の高い方を特定
優先サブステ = 優先度順位で比較して決定

// 3. 再構築後の理論値を計算（重要：×1状態にリセット）
// 優先サブステ: ×1時点の値 + (最大ロール値 × 残り強化回数)
// 非優先サブステ: ×1時点の値（初回ロール値のみ）
// その他の2サブステ: ×1時点の値

優先サブステの理論値 = rollValues[0] + (最大ロール値 × 残り強化回数)
非優先サブステの理論値 = rollValues[0]
その他サブステの理論値 = rollValues[0] (各々)

// 4. 理論スコアを計算（スコア計算対象チェックボックスで選択されたもののみ）
理論スコア = Σ(スコア対象の各サブステの理論値 × スコア係数)

// 注意: スコア対象には、選択した2つ以外のサブステも含まれる可能性がある
// 例: 選択サブステ=[会心率, 会心ダメージ], スコア対象=[会心率, 会心ダメージ, 攻撃力%]
// この場合、攻撃力%も理論スコア計算に含まれる（×1時点の値で）
```

**表示例（パターン1: スコア対象=選択2つのみ）**:
```
理論最大値（選択サブオプション）

優先: 会心率（残り5回強化）
• 会心率: 22.6%
  (初回値 3.1% + 最大値3.9% × 5回)
• 会心ダメージ: 6.2% (初回値のみ)

再構築前スコア: 42.0
  (会心率 7.0×2 + 会心ダメージ 28.0×1)
  
理論スコア: 51.4
  (会心率 22.6×2 + 会心ダメージ 6.2×1)
```

**表示例（パターン2: スコア対象に他のサブステも含む）**:
```
理論最大値（選択サブオプション）

優先: 会心率（残り5回強化）
• 会心率: 22.6%
  (初回値 3.1% + 最大値3.9% × 5回)
• 会心ダメージ: 6.2% (初回値のみ)
• 攻撃力%: 4.1% (初回値のみ)

再構築前スコア: 51.9
  (会心率 7.0×2 + 会心ダメージ 28.0×1 + 攻撃力% 9.9×1)
  
理論スコア: 55.5
  (会心率 22.6×2 + 会心ダメージ 6.2×1 + 攻撃力% 4.1×1)
```

**具体例（初期4聖遺物、スコア対象に攻撃力%を含む）**:
```
再構築前:
- 会心率: 7.0% (3.1% + 3.9%) ×1回強化
- 会心ダメージ: 28.0% (6.2% + 7.0% + 7.8% + 7.0%) ×3回強化
- 攻撃力%: 9.9% (4.1% + 5.8%) ×1回強化
- 元素チャージ効率: 5.5% ×0回強化
- 総強化回数: 5回
- スコア対象: 会心率、会心ダメージ、攻撃力%
- 現在スコア: 51.9 (7.0×2 + 28.0×1 + 9.9×1)

再構築後（会心率優先、残り5回）:
- 会心率: 22.6% (3.1% + 3.9% × 5回) ×5回強化
- 会心ダメージ: 6.2% (初回値のみ) ×1回強化
- 攻撃力%: 4.1% (初回値のみ) ×1回強化
- 元素チャージ効率: 5.5% (初回値のみ) ×1回強化
- 理論スコア: 55.5 (22.6×2 + 6.2×1 + 4.1×1)
- スコア増加: +3.6
```

**実装上の注意**:
- 再構築は聖遺物を×1の状態に戻す（初回ロール値のみ保持）
- 初期サブステ数（3または4）により残り強化回数が異なる
  - 初期4: 5回強化可能
  - 初期3: 4回強化可能（+4で1つ追加されるため）
- 優先度の高い方を残り全回数強化した場合のスコアを計算
- その他のサブステは初回値（×1時点）で計算

---

### 6. 更新率計算・表示

**定義**: 再構築を実行した場合に、現在のスコア（スコア対象選択を反映）より高いスコアになる確率

#### 6.1 計算方法（Phase 1: 組み合わせ総当たり計算）

**前提条件**:
- 初期サブステ4つの場合: 合計5回強化（+0から+4, +8, +12, +16, +20）
- 初期サブステ3つの場合: 合計4回強化（+4で1つ追加済み、+8, +12, +16, +20）
- 再構築により聖遺物は×1状態（初回ロール値のみ）にリセット
- 4つのサブステータスのうち、どれが強化されるかはランダム（各25%）
- 各サブステの上昇値は4段階（最小/中低/中高/最大、各25%）
- 再構築種別により「保証回数」が異なる（選択サブステからの強化が保証される）
- 保証回数以降は4つのサブステから完全ランダム抽選

**計算式（正確版）**:

```dart
// 変数:
// - 総強化回数: 5回（初期4）または4回（初期3）
// - 保証回数: 2回（通常）/ 3回（上級）/ 4回（絶対）
// - 非保証回数: 総強化回数 - 保証回数
// - 選択サブステ: 2個
// - 全サブステ: 4個

// ステップ1: 初期値時点でのスコアを計算
初期値スコア = Σ(スコア対象の各サブステのrollValues[0] × スコア係数)

// ステップ2: 目標スコアを計算（現在スコアを超えるために必要）
目標スコア = 現在スコア + 0.1 - 初期値スコア
// 例: (51.9 + 0.1) - 16.5 = 35.5

// ステップ3: 全ての強化パターンを生成・評価
成功パターン数 = 0
総パターン数 = 0

// 保証回数分: 選択2サブステから抽選
for (保証回数分の全組み合わせ) {
  // 各保証枠で選択2サブステのいずれか + 4段階ロール値
  // 2サブステ × 4段階 = 8通り/回
  // 保証2回: 8^2 = 64通り
  // 保証3回: 8^3 = 512通り
  // 保証4回: 8^4 = 4096通り
  
  // 非保証回数分: 全4サブステから抽選
  for (非保証回数分の全組み合わせ) {
    // 各非保証枠で全4サブステのいずれか + 4段階ロール値
    // 4サブステ × 4段階 = 16通り/回
    // 非保証3回: 16^3 = 4096通り
    // 非保証2回: 16^2 = 256通り
    // 非保証1回: 16^1 = 16通り
    
    総パターン数++
    
    // このパターンでのスコアを計算
    パターンスコア = 初期値スコア
    for (各強化) {
      強化サブステ = 抽選されたサブステ
      ロール値 = 抽選されたTierのロール値
      
      if (強化サブステ がスコア対象に含まれる) {
        パターンスコア += ロール値 × スコア係数
      }
    }
    
    // 目標スコアを超えたら成功
    if (パターンスコア >= 目標スコア) {
      成功パターン数++
    }
  }
}

更新率 = (成功パターン数 / 総パターン数) × 100

// パターン数の計算例（初期4、通常再構築）:
// 保証2回: 8^2 = 64通り
// 非保証3回: 16^3 = 4096通り
// 総パターン数: 64 × 4096 = 262,144通り
```

**具体例（初期4聖遺物、通常再構築）**:

```
前提:
- 会心率: 7.0% (3.1% + 3.9%) ×1回
- 会心ダメージ: 28.0% (6.2% + 7.0% + 7.8% + 7.0%) ×3回
- 攻撃力%: 9.9% (4.1% + 5.8%) ×1回
- 元素チャージ効率: 5.5% ×0回
- スコア対象: 会心率、会心ダメージ、攻撃力%
- 現在スコア: 51.9
- 選択サブステ: 会心率、会心ダメージ

計算:
1. 初期値スコア = 3.1×2 + 6.2×1 + 4.1×1 = 16.5
2. 目標スコア = (51.9 + 0.1) - 16.5 = 35.5

3. パターン生成（通常再構築: 保証2回 + 非保証3回）
   - 保証2回: 会心率(2.7/3.1/3.5/3.9) または 会心ダメージ(5.4/6.2/7.0/7.8)
   - 非保証3回: 4サブステ(会心率/ダメージ/攻撃力/チャージ) × 4段階

4. 成功パターン例:
   - 保証1回目: 会心率 3.9% → スコア +7.8
   - 保証2回目: 会心ダメージ 7.8% → スコア +7.8
   - 非保証1回目: 攻撃力% 5.8% → スコア +5.8
   - 非保証2回目: チャージ効率 6.5% → スコア +0（対象外）
   - 非保証3回目: 会心率 3.9% → スコア +7.8
   - 合計スコア増加: 29.2 < 35.5 → 失敗

5. 全262,144通りを評価し、成功パターン数をカウント

更新率 = (成功パターン数 / 262,144) × 100
```

**パターン数一覧**:

| 再構築種別 | 総強化回数 | 保証回数 | 非保証回数 | 総パターン数 |
|----------|----------|---------|----------|------------|
| 通常（初期4） | 5回 | 2回 | 3回 | 8² × 16³ = 262,144 |
| 上級（初期4） | 5回 | 3回 | 2回 | 8³ × 16² = 131,072 |
| 絶対（初期4） | 5回 | 4回 | 1回 | 8⁴ × 16¹ = 65,536 |
| 通常（初期3） | 4回 | 2回 | 2回 | 8² × 16² = 16,384 |
| 上級（初期3） | 4回 | 3回 | 1回 | 8³ × 16¹ = 8,192 |
| 絶対（初期3） | 4回 | 4回 | 0回 | 8⁴ × 16⁰ = 4,096 |

**実装上の注意**:
- パターン数は最大26万通り程度なので、全探索可能
- ネストループで実装（保証回数分 × 非保証回数分）
- 各ループで選択肢（8通りまたは16通り）を列挙
- スコア対象外のサブステが強化されても考慮する（スコアに加算されないだけ）

**表示例（更新可能な場合）**:
```
更新率（通常再構築）
■■■■■░░░░░ 42.3%
(262,144通りのパターンを評価)

成功パターン: 110,892 / 262,144
(現在スコア 51.9 を超える確率)
  
現在スコア: 51.9 → 理論スコア: 55.5 (+3.6)
```

**表示例（更新不可の場合）**:
```
更新率（通常再構築）
░░░░░░░░░░ 0.0%
(理論値でも現在を超えられません)

理論スコア: 43.6 < 現在スコア: 50.0
```

**表示例（比較: 3種類の再構築）**:
```
📈 更新率比較

通常再構築（保証2回）
■■■■■░░░░░ 42.3%
110,892 / 262,144 パターン

上級再構築（保証3回）
■■■■■■■░░░ 68.5%
89,780 / 131,072 パターン

絶対再構築（保証4回）
■■■■■■■■■░ 89.2%
58,454 / 65,536 パターン
```

#### 6.2 計算アルゴリズムの詳細

**実装方法: 再帰的パターン生成**

```dart
/// 更新率を計算（全パターン総当たり）
double calculateUpdateRate({
  required List<SubstatSummary> allSubstats,
  required Set<String> selectedPropIds, // 選択した2つ
  required Set<String> scoreTargetPropIds, // スコア対象
  required Map<String, double> scoreCoefficients, // スコア係数
  required double currentScore,
  required int totalEnhancements, // 5 or 4
  required int guaranteedRolls, // 2, 3, or 4
}) {
  // 1. 初期値スコア計算
  double initialScore = 0.0;
  for (final substat in allSubstats) {
    if (scoreTargetPropIds.contains(substat.propId)) {
      final coef = scoreCoefficients[substat.propId] ?? 1.0;
      initialScore += substat.rollValues[0] * coef;
    }
  }
  
  // 2. 目標スコア計算
  final targetScore = currentScore + 0.1 - initialScore;
  
  // 3. 選択サブステの情報取得
  final selectedSubstats = allSubstats
      .where((s) => selectedPropIds.contains(s.propId))
      .toList();
  
  // 4. パターン生成・評価
  int successCount = 0;
  int totalCount = 0;
  
  // 保証回数分のパターン生成（再帰）
  _generateGuaranteedPatterns(
    guaranteedRolls: guaranteedRolls,
    selectedSubstats: selectedSubstats,
    currentPattern: [],
    onPatternComplete: (guaranteedPattern) {
      // 非保証回数分のパターン生成（再帰）
      final nonGuaranteedRolls = totalEnhancements - guaranteedRolls;
      
      _generateNonGuaranteedPatterns(
        nonGuaranteedRolls: nonGuaranteedRolls,
        allSubstats: allSubstats,
        currentPattern: [],
        onPatternComplete: (nonGuaranteedPattern) {
          totalCount++;
          
          // スコア計算
          double patternScore = initialScore;
          
          // 保証分を加算
          for (final roll in guaranteedPattern) {
            if (scoreTargetPropIds.contains(roll.propId)) {
              final coef = scoreCoefficients[roll.propId] ?? 1.0;
              patternScore += roll.value * coef;
            }
          }
          
          // 非保証分を加算
          for (final roll in nonGuaranteedPattern) {
            if (scoreTargetPropIds.contains(roll.propId)) {
              final coef = scoreCoefficients[roll.propId] ?? 1.0;
              patternScore += roll.value * coef;
            }
          }
          
          // 判定
          if (patternScore >= targetScore) {
            successCount++;
          }
        },
      );
    },
  );
  
  return (successCount / totalCount) * 100.0;
}

/// 保証回数分のパターンを再帰的に生成
void _generateGuaranteedPatterns({
  required int guaranteedRolls,
  required List<SubstatSummary> selectedSubstats,
  required List<Roll> currentPattern,
  required void Function(List<Roll>) onPatternComplete,
}) {
  if (currentPattern.length == guaranteedRolls) {
    onPatternComplete(currentPattern);
    return;
  }
  
  // 選択2サブステ × 4段階 = 8通り
  for (final substat in selectedSubstats) {
    for (int tier = 1; tier <= 4; tier++) {
      final roll = Roll(
        propId: substat.propId,
        value: _getRollValueByTier(substat, tier),
      );
      
      _generateGuaranteedPatterns(
        guaranteedRolls: guaranteedRolls,
        selectedSubstats: selectedSubstats,
        currentPattern: [...currentPattern, roll],
        onPatternComplete: onPatternComplete,
      );
    }
  }
}

/// 非保証回数分のパターンを再帰的に生成
void _generateNonGuaranteedPatterns({
  required int nonGuaranteedRolls,
  required List<SubstatSummary> allSubstats,
  required List<Roll> currentPattern,
  required void Function(List<Roll>) onPatternComplete,
}) {
  if (currentPattern.length == nonGuaranteedRolls) {
    onPatternComplete(currentPattern);
    return;
  }
  
  // 全4サブステ × 4段階 = 16通り
  for (final substat in allSubstats) {
    for (int tier = 1; tier <= 4; tier++) {
      final roll = Roll(
        propId: substat.propId,
        value: _getRollValueByTier(substat, tier),
      );
      
      _generateNonGuaranteedPatterns(
        nonGuaranteedRolls: nonGuaranteedRolls,
        allSubstats: allSubstats,
        currentPattern: [...currentPattern, roll],
        onPatternComplete: onPatternComplete,
      );
    }
  }
}

/// Tierに応じたロール値を取得
double _getRollValueByTier(SubstatSummary substat, int tier) {
  // tier: 1=最小, 2=中低, 3=中高, 4=最大
  // stats_append.jsonの値を使用
  switch (tier) {
    case 1: return substat.minRollValue;
    case 2: return (substat.minRollValue + substat.avgRollValue) / 2;
    case 3: return (substat.avgRollValue + substat.maxRollValue) / 2;
    case 4: return substat.maxRollValue;
    default: return substat.avgRollValue;
  }
}

class Roll {
  const Roll({required this.propId, required this.value});
  final String propId;
  final double value;
}
```

**ロール値の確率分布**（stats_append.jsonより）:
```
各サブステータスに4段階のロール値が存在:
- Tier 1（最小値）: 会心率 2.7%、会心ダメージ 5.4%、攻撃力% 4.1%...
- Tier 2（中低値）: 会心率 3.1%、会心ダメージ 6.2%、攻撃力% 4.7%...
- Tier 3（中高値）: 会心率 3.5%、会心ダメージ 7.0%、攻撃力% 5.3%...
- Tier 4（最大値）: 会心率 3.9%、会心ダメージ 7.8%、攻撃力% 5.8%...

各Tierの出現確率: 25%（均等分布と仮定）
```

**パフォーマンス考慮**:
- 最大26万通りの評価が必要（初期4、通常再構築）
- 現代のブラウザでは数秒で計算可能
- 計算中はローディングインジケータを表示
- Web Workerでバックグラウンド処理も検討可能

---

## 🎨 UI設計

### 全体レイアウト

```
┌─────────────────────────────────────────┐
│ 再構築シミュレーター                      │
├─────────────────────────────────────────┤
│                                         │
│ 希望サブオプションを選択（2つ選択必須）   │
│ ● 会心率                                │
│ ● 会心ダメージ                          │
│ ○ 攻撃力%                               │
│ ○ 元素チャージ効率                      │
│                                         │
│ スコア計算対象を選択                     │
│ ☑ 会心率                                │
│ ☑ 会心ダメージ                          │
│ ☐ 攻撃力%                               │
│ ☐ 元素チャージ効率                      │
│                                         │
│ 再構築種別を選択                         │
│ ◉ 通常再構築（保証2回）                  │
│ ○ 上級再構築（保証3回）                  │
│ ○ 絶対再構築（保証4回）                  │
│                                         │
│ ───────────────────────────────        │
│                                         │
│ 📊 現在の状態（再構築前）                │
│ • 会心率: 7.0% (×1回強化)               │
│ • 会心ダメージ: 28.0% (×3回強化)        │
│ • 攻撃力%: 9.9% (×1回強化)              │
│ • 元素チャージ効率: 5.5% (×0回) ※グレー│
│                                         │
│ スコア対象合計: 51.9                    │
│ (会心率 7.0×2 + 会心ダメージ 28.0 + 攻撃力% 9.9)│
│                                         │
│ 🎯 理論最大値（選択サブオプション）       │
│ 優先: 会心率（残り5回強化）              │
│ • 会心率: 22.6%                         │
│   (初回値 3.1% + 最大値3.9% × 5回)     │
│ • 会心ダメージ: 6.2% (初回値のみ)       │
│ • 攻撃力%: 4.1% (初回値のみ)            │
│ • 元素チャージ効率: 5.5% (初回値) ※グレー│
│                                         │
│ 理論スコア: 55.5                        │
│ (会心率 22.6×2 + 会心ダメージ 6.2 + 攻撃力% 4.1)│
│                                         │
│ 📈 更新率（通常再構築）                  │
│ ■■■■■░░░░░ 42.3%                    │
│ 成功: 110,892 / 262,144 パターン        │
│                                         │
│ 現在 51.9 → 理論 55.5 (+3.6)           │
│                                         │
│ ［他の再構築種別と比較］ボタン           │
│                                         │
└─────────────────────────────────────────┘
```

### 状態管理

**無効状態**:
- サブステータスを2つ選択していない場合
  - 「理論最大値」「更新率」セクションをグレーアウト
  - 「2つのサブステータスを選択してください」メッセージを表示

**有効状態**:
- サブステータスを2つ選択済み
  - 再構築種別を変更すると即座に更新率を再計算
  - 計算結果をアニメーション付きで表示

---

## 📁 実装ファイル構成

```
lib/src/
├── models/domain/
│   ├── rebuild_type.dart (新規)
│   └── rebuild_simulation_result.dart (新規)
├── services/
│   └── rebuild_simulator_service.dart (新規)
└── screens/reliquary_detail_screen/
    └── lib/
        ├── reliquary_detail_screen.dart (既存・修正)
        └── rebuild_simulator_view.dart (新規)
```

### ファイル詳細

#### 1. `rebuild_type.dart`

```dart
/// 再構築種別
enum RebuildType {
  /// 通常再構築（保証2回）
  normal(guaranteedRolls: 2, label: '通常再構築（保証2回）'),
  
  /// 上級再構築（保証3回）
  advanced(guaranteedRolls: 3, label: '上級再構築（保証3回）'),
  
  /// 絶対再構築（保証4回）
  absolute(guaranteedRolls: 4, label: '絶対再構築（保証4回）');

  const RebuildType({
    required this.guaranteedRolls,
    required this.label,
  });

  /// 保証強化回数
  final int guaranteedRolls;
  
  /// 表示ラベル
  final String label;
}
```

#### 2. `rebuild_simulation_result.dart`

```dart
/// 再構築シミュレーション結果
class RebuildSimulationResult {
  const RebuildSimulationResult({
    required this.currentScore,
    required this.theoreticalMaxScore,
    required this.expectedScore,
    required this.updateRate,
    required this.primarySubstat,
    required this.secondarySubstat,
    required this.allSubstats,
    required this.theoreticalValues,
    required this.remainingEnhancements,
    required this.isUpdatePossible,
  });

  /// 現在のスコア（スコア対象選択を反映）
  final double currentScore;
  
  /// 理論最大スコア（優先サブステを最大回数強化、×1状態から）
  final double theoreticalMaxScore;
  
  /// 期待スコア（保証回数を平均ロール値で計算）
  final double expectedScore;
  
  /// 更新率（0.0～1.0）
  final double updateRate;
  
  /// 優先サブステータス
  final SubstatSummary primarySubstat;
  
  /// 非優先サブステータス
  final SubstatSummary secondarySubstat;
  
  /// 全サブステータス（4つ）
  final List<SubstatSummary> allSubstats;
  
  /// 各サブステの理論値（×1状態から計算、優先のみ最大回数強化）
  /// Map<propId, theoreticalValue>
  final Map<String, double> theoreticalValues;
  
  /// 残り強化回数（初期3なら4回、初期4なら5回）
  final int remainingEnhancements;
  
  /// 更新可能か（理論スコア > 現在スコア）
  final bool isUpdatePossible;
}
```

#### 3. `rebuild_simulator_service.dart`

```dart
/// 再構築シミュレーターサービス
class RebuildSimulatorService {
  /// サブステータスの優先度（高い方を優先的に強化）
  static const _substatPriority = {
    'FIGHT_PROP_CRITICAL': 7,        // 会心率
    'FIGHT_PROP_CRITICAL_HURT': 6,   // 会心ダメージ
    'FIGHT_PROP_DEFENSE_PERCENT': 5, // 防御力%
    'FIGHT_PROP_CHARGE_EFFICIENCY': 4, // 元素チャージ効率
    'FIGHT_PROP_ATTACK_PERCENT': 3,  // 攻撃力%
    'FIGHT_PROP_HP_PERCENT': 2,      // HP%
    'FIGHT_PROP_ELEMENT_MASTERY': 1, // 元素熟知
  };
  
  /// 再構築シミュレーション結果を計算
  RebuildSimulationResult simulate({
    required SubstatSummary substat1,
    required SubstatSummary substat2,
    required RebuildType rebuildType,
    required int totalEnhancements, // 現在の総強化回数
  }) {
    // 実装内容は後述
  }
  
  /// 更新率を計算（簡易版）
  double _calculateUpdateRate({
    required int guaranteedRolls,
    required int totalSubstats,
    required int selectedSubstats,
  }) {
    // 保証回数内に選択サブステが強化される確率
    final nonSelectedProb = (totalSubstats - selectedSubstats) / totalSubstats;
    return 1 - pow(nonSelectedProb, guaranteedRolls);
  }
}
```

---

## 🔄 実装フェーズ

### Phase 1: 基本実装（必須）
- ✅ タブUI追加（完了）
- ⬜ サブステータス選択UI（2つ必須、現在の4つのみ表示）
- ⬜ スコア計算対象選択UI（チェックボックス）
- ⬜ 再構築種別選択UI
- ⬜ 現在の状態表示（再構築前、×回強化を表示）
- ⬜ 理論最大値計算・表示（優先度考慮、×1時点にリセット）
- ⬜ 正確な更新率計算（全パターン総当たり、初期3/4考慮）
  - ⬜ 保証回数分のパターン生成（8^n通り）
  - ⬜ 非保証回数分のパターン生成（16^m通り）
  - ⬜ 各パターンでのスコア計算
  - ⬜ 成功パターン数のカウント
- ⬜ 成功パターン数の表示

### Phase 2: 拡張実装（オプション）
- ⬜ 3種類の再構築の比較表示
- ⬜ ローディングインジケータ（計算中）
- ⬜ Web Workerでのバックグラウンド計算
- ⬜ キャッシュ機能（同じ条件の再計算を回避）

---

## ✅ テストケース

### 1. サブステータス選択
- [ ] 2つ選択するまで計算セクションが無効
- [ ] 3つ以上選択不可（2つ目選択時に1つ目が自動解除）
- [ ] 現在の聖遺物の4つのサブステのみ表示

### 2. スコア計算対象選択
- [ ] 一覧画面と同様のチェックボックスUI
- [ ] デフォルト: 会心率・会心ダメージのみ選択
- [ ] 選択変更時にスコア再計算

### 3. 優先度判定
- [ ] 会心率 vs 会心ダメージ → 会心率が優先
- [ ] 攻撃力% vs 元素熟知 → 攻撃力%が優先
- [ ] 防御力% vs 元素チャージ効率 → 防御力%が優先

### 4. 理論値計算
- [ ] 残り強化回数が初期3/4で正しく計算される（4回 or 5回）
- [ ] 全サブステが×1時点の値（rollValues[0]）にリセット
- [ ] 優先サブステのみが残り全回数強化される
- [ ] 最大ロール値が正しく使用される
- [ ] スコア対象に選択した2つ以外のサブステも含む場合、それらも理論スコアに反映される（×1時点の値で）

### 5. 更新率計算
- [ ] 理論スコア <= 現在スコアの場合は0%
- [ ] 理論スコア > 現在スコアの場合:
  - [ ] 全パターン総当たり計算
  - [ ] 保証回数分のパターン生成（8^n通り）
  - [ ] 非保証回数分のパターン生成（16^m通り）
  - [ ] 各パターンでスコア対象選択を反映
  - [ ] 目標スコアを超えるパターン数をカウント
  - [ ] 更新率 = 成功パターン数 / 総パターン数
- [ ] パターン数一覧:
  - [ ] 通常・初期4: 262,144通り
  - [ ] 上級・初期4: 131,072通り
  - [ ] 絶対・初期4: 65,536通り
  - [ ] 通常・初期3: 16,384通り
  - [ ] 上級・初期3: 8,192通り
  - [ ] 絶対・初期3: 4,096通り

---

## 📝 備考

### 前提条件
- 聖遺物は+20まで強化済みとする（+20未満の場合の挙動は別途定義）
- 初期サブステ数（3または4）は `ReliquarySummary.initialSubstatCount` から取得
- 総強化回数:
  - 初期4: 5回（+0, +4, +8, +12, +16, +20）
  - 初期3: 4回（+4で1つ追加、+8, +12, +16, +20）
- 再構築により聖遺物は×1状態にリセット（初回ロール値 `rollValues[0]` のみ保持）

### 制約事項
- Phase 1では全パターン総当たり計算を実装（正確な確率）
- ロール値の確率分布は均等（25%ずつ）と仮定
- 最大26万通りの評価が必要（計算時間: 数秒程度）
- サブステータス選択確率も均等（25%ずつ）と仮定

### 既知の問題
- ゲーム内の実際のロール確率は不明（miHoYo非公開）
- サブステータス選択確率も均等と仮定（実際は偏りがある可能性）

---

## 📊 実証計算結果

### 検証ケース1: 初期4オプション、スコア52.0を目指す

**前提条件**:
```
初期サブステータス（+0）:
- 会心率: 3.1%
- 会心ダメージ: 6.2%
- 攻撃力%: 4.1%
- 元素チャージ効率: 5.5%

選択サブオプション: 会心率、会心ダメージ
スコア計算対象: 会心率、会心ダメージ、攻撃力%
目標スコア: 52.0
```

**ロール値（stats_append.jsonより）**:
```
会心率: [2.7, 3.1, 3.5, 3.9]
会心ダメージ: [5.4, 6.2, 7.0, 7.8]
攻撃力%: [4.1, 4.7, 5.3, 5.8]
元素チャージ効率: [4.5, 5.2, 5.8, 6.5]
```

**計算結果**:

| 再構築種別 | 確定強化 | 非確定強化 | 総パターン数 | 成功パターン数 | **確率** |
|---------|---------|----------|------------|------------|---------|
| **確定なし（通常強化）** | 0回 | 5回 | 1,048,576 | 672 | **0.1%** |
| **通常再構築** | 2回 | 3回 | 262,144 | 672 | **0.3%** |
| **上級再構築** | 3回 | 2回 | 131,072 | 672 | **0.5%** |
| **絶対再構築** | 4回 | 1回 | 65,536 | 672 | **1.0%** |

**重要な発見**:
1. **成功パターン数は全て672で同じ**
   - スコア52.0を達成できる強化の組み合わせは672通りのみ
   - 確定強化はこの672通りが出現する確率を上げる効果
   
2. **確率の違いは総パターン数の減少によるもの**
   - 確定強化により選択肢が絞られる → 総パターン数が減少
   - 相対的に成功確率が上昇
   - しかし絶対再構築でも1.0%という厳しい確率
   
3. **4段階の値抽選が確率を厳しくする**
   - 確定強化があっても4段階（最小/中低/中高/最大）の抽選がある
   - 高い値を引く必要があるため確率は上がりにくい

### 検証ケース2: 既存聖遺物の更新（スコア51.9から）

**前提条件**:
```
現在の聖遺物（+20）:
- 会心率: 7.0% (3.1% + 3.9%) ×1回
- 会心ダメージ: 28.0% (6.2% + 7.0% + 7.8% + 7.0%) ×3回
- 攻撃力%: 9.9% (4.1% + 5.8%) ×1回
- 元素チャージ効率: 5.5% ×0回
- 現在スコア: 51.9

選択サブオプション: 会心率、会心ダメージ
スコア計算対象: 会心率、会心ダメージ、攻撃力%

計算詳細:
- 初期値スコア（×1状態）: 3.1×2 + 6.2×1 + 4.1×1 = 16.5
- 目標スコア: (51.9 + 0.1) - 16.5 = 35.5
```

**計算結果**:

| 再構築種別 | 総パターン数 | 成功パターン数 | **更新率** |
|---------|------------|------------|---------|
| **通常再構築** | 262,144 | 144,864 | **55.3%** |
| **上級再構築** | 131,072 | 98,448 | **75.1%** |
| **絶対再構築** | 65,536 | 61,280 | **93.5%** |

**結論**:
- **再構築は「既に良い聖遺物をさらに良くする」機能**
- スコア51.9から52.0への更新（+0.1）は高確率で達成可能
- スコア0から52.0への到達（+52.0）は極めて困難（0.3～1.0%）
- 再構築前の値が高いほど更新のハードルは上がるが、初期4オプションから育成するより遥かに現実的

### 計算方法の背景

**再構築の本質**:
```
再構築 = 聖遺物を+0の状態に初期化 + 選択サブステを確定強化できる状態で+20まで育て直し
```

**なぜ成功パターン数が同じなのか**:
- スコア52.0を達成する強化の組み合わせは672通りしか存在しない
- 確定強化は、その672通りの中で「選択サブステが強化されるパターン」の出現確率を上げる
- 選択サブステ以外が強化されるパターンは除外される → 総パターン数が減少
- 結果として、成功パターン数（672）÷ 総パターン数 = 確率が上昇

**計算の前提条件**:
1. 各サブステの選択確率: 25%（均等分布と仮定）
2. ロール値の4段階確率: 各25%（均等分布と仮定）
3. 再構築により聖遺物は×1状態にリセット
4. 初期4の場合: 5回強化、初期3の場合: 4回強化
5. 確定強化: 選択2サブステから必ず抽選（8通り/回）
6. 非確定強化: 全4サブステから抽選（16通り/回）

---

**最終更新**: 2025年10月22日  
**レビュー者**: GitHub Copilot  
**承認状況**: 設計完了、実装待ち
