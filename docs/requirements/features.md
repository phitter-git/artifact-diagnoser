# 機能詳細仕様

このドキュメントでは、聖遺物診断器の各機能の詳細仕様を定義します。

---

## 📖 目次

1. [UID読み込み機能](#uid読み込み機能)
2. [サブオプション分析機能](#サブオプション分析機能)
3. [初期値表示機能](#初期値表示機能)
4. [スコアリング機能](#スコアリング機能)
5. [理論値計算機能](#理論値計算機能)
6. [再構築更新率計算機能](#再構築更新率計算機能)
7. [部位別ランク付け機能](#部位別ランク付け機能)
8. [再構築推奨機能](#再構築推奨機能)
9. [データ保存機能](#データ保存機能)

---

## 1. UID読み込み機能

### 概要
ユーザーのGenshin Impact UIDを入力し、REST API経由で聖遺物データを取得します。

### ユーザーストーリー
> ユーザーとして、自分のUIDを入力することで、現在所持している聖遺物データを自動的に読み込みたい。

### 機能要件

#### 1.1 UID入力
- ユーザーはテキストフィールドにUIDを入力できる
- UIDは9桁の数字（例: 123456789）
- 入力バリデーション：
  - 9桁であること
  - 数字のみであること
  - 空文字でないこと

#### 1.2 データ取得
- 「読み込み」ボタンをクリックすると、API経由でデータを取得
- ローディング表示（スピナー + "読み込み中..." メッセージ）
- 取得した聖遺物データを内部モデルに変換（remote → domain）

#### 1.3 エラーハンドリング

| エラータイプ | 原因 | 表示メッセージ | アクション |
|-------------|------|---------------|-----------|
| 不正なUID | 形式エラー | "UIDは9桁の数字で入力してください" | 入力欄を赤くハイライト |
| 通信エラー | ネットワーク障害 | "通信エラーが発生しました。ネットワークを確認してください" | リトライボタン表示 |
| APIエラー | サーバー側エラー | "データの取得に失敗しました（エラーコード: XXX）" | リトライボタン表示 |
| データ不正 | パースエラー | "データの形式が不正です" | サポートへの連絡リンク |

### UI/UX要件

#### レイアウト
```
┌─────────────────────────────────┐
│  聖遺物診断器                     │
├─────────────────────────────────┤
│  UID を入力してください           │
│  ┌───────────────┐  [読み込み]   │
│  │  123456789    │              │
│  └───────────────┘              │
│                                 │
│  💡 UID は Genshin Impact の     │
│     ゲーム内で確認できます        │
└─────────────────────────────────┘
```

#### インタラクション
1. 入力フォーカス時：プレースホルダー非表示
2. 入力中：リアルタイムバリデーション（数字以外は入力不可）
3. 読み込み中：ボタン無効化、スピナー表示
4. 成功時：聖遺物一覧画面へ遷移（フェードイン）
5. エラー時：エラーメッセージ表示（スナックバーまたはダイアログ）

### データフロー
```
User Input (UID)
    ↓
Validation
    ↓
API Request (GET /api/user/{uid})
    ↓
Response (JSON)
    ↓
Parse (UserData model)
    ↓
Convert (remote → domain)
    ↓
Display (ReliquarySummary list)
```

### 技術仕様
- **API Endpoint**: `https://enka.network/api/uid/{uid}` （仮）
- **HTTPメソッド**: GET
- **レスポンス形式**: JSON
- **タイムアウト**: 10秒
- **リトライ**: 3回まで（指数バックオフ）

---

## 2. サブオプション分析機能

### 概要
聖遺物のサブオプションが強化レベル+4/+8/+12/+16/+20でどのように変化したかを分析します。

### ユーザーストーリー
> ユーザーとして、聖遺物が強化された履歴を見ることで、どのサブステータスが強化されたか、どの数値が抽選されたかを理解したい。

### 機能要件

#### 2.1 強化履歴の解析
- 現在のサブオプション値から逆算
- 各強化段階（+0/+4/+8/+12/+16/+20）の状態を復元
- 強化されたサブステータスを特定
- 抽選された数値（4段階）を判定

#### 2.2 強化段階の切り替え
- タブで+0～+20を切り替え
- 選択した段階のサブオプション値を表示
- 強化されたサブステータスをハイライト

#### 2.3 抽選値の表示
各サブステータスの抽選値を4段階で表示：
- 最小値（例: 会心率 2.7%）
- 中間値1（例: 会心率 3.1%）
- 中間値2（例: 会心率 3.5%）
- 最大値（例: 会心率 3.9%）

### UI/UX要件

#### レイアウト
```
┌─────────────────────────────────┐
│  [+0] [+4] [+8] [+12] [+16] [+20]│
├─────────────────────────────────┤
│  サブオプション                   │
│                                 │
│  ● 会心率        7.8%  [↑ +3.5%]│
│  ● 会心ダメージ   20.2%          │
│  ○ 攻撃力%       9.9%           │
│  ○ 防御力%       6.5%           │
│                                 │
│  ● = 初期サブオプション            │
│  [↑] = この段階で強化された       │
│  (1段階につき1つのみ強化)         │
└─────────────────────────────────┘
```

#### インタラクション
1. タブクリック：対応する強化段階を表示
2. 強化されたサブステータス：緑色でハイライト
3. 抽選値の色分け（4段階）：
   - 最大値（3.9%）：金色 🥇
   - 中間値2（3.5%）：銀色 🥈
   - 中間値1（3.1%）：銅色 🥉
   - 最小値（2.7%）：白色 ⚪

### 計算ロジック
```dart
class SubstatAnalysis {
  final int level; // 0, 4, 8, 12, 16, 20
  final List<SubstatValue> substats;
  final List<SubstatEnhancement> enhancements;
}

class SubstatEnhancement {
  final int atLevel; // 強化されたレベル
  final String statType; // 強化されたステータス
  final double addedValue; // 追加された値
  final RollQuality quality; // 4段階の抽選品質
}

enum RollQuality { 
  min,      // 最小値（例: 2.7%）
  midLow,   // 中間値1（例: 3.1%）
  midHigh,  // 中間値2（例: 3.5%）
  max       // 最大値（例: 3.9%）
}
```

---

## 3. 初期値表示機能

### 概要
聖遺物を取得した時点（初期状態）のサブオプションを表示します。

### ユーザーストーリー
> ユーザーとして、「聖啓の塵」で再構築を行う際、初期値は据え置きでサブオプションの強化値のみが再抽選されるため、再構築前に初期値が良かったかどうかを確認したい。そうすることで、再構築すべき聖遺物かどうかを判断できる。

### 機能要件

#### 3.1 初期状態の判定
- サブオプション3つ → 初期レベルは+4（1回強化済み）
- サブオプション4つ → 初期レベルは+0（強化前）

#### 3.2 初期値の表示
- 初期値バッジを表示（"初期値" または "Initial"）
- 初期値と現在値の比較表示
- 増加量の表示（例: +14.5%）

### UI/UX要件

#### レイアウト
```
┌─────────────────────────────────┐
│  初期状態 [バッジ]                │
├─────────────────────────────────┤
│  サブオプション                   │
│                                 │
│  会心率        7.8%              │
│  会心ダメージ   5.4% → 20.2%     │
│  攻撃力%       9.9%              │
│  （+4で追加）                    │
│                                 │
│  💡 再構築では初期値は変わりません │
└─────────────────────────────────┘
```

---

## 4. スコアリング機能

詳細は [scoring_logic.md](./scoring_logic.md) を参照してください。

### 概要
ユーザーが選択したステータスに基づいて聖遺物のスコアを計算します。

### 主要機能
- 基本スコア計算（会心率×2、会心ダメ、攻撃%等）
- ステータス選択UI（複数選択可）
- スコアの視覚的表示（色分け、ランク）

---

## 5. 理論値計算機能

### 概要
聖遺物が理想的に強化された場合の最大スコアを計算します。

### ユーザーストーリー
> ユーザーとして、この聖遺物がどこまで育つ可能性があるのかを知りたい。

### 機能要件

#### 5.1 理論値の計算
- 残り強化回数を算出
- 選択中のステータスで最大値強化を仮定
- 最大到達可能スコアを計算

#### 5.2 達成率の表示
- 現在スコア / 理論値 × 100%
- プログレスバーで視覚化
- 残りのポテンシャル表示

### 計算式
```
残り強化回数 = (20 - 現在レベル) / 4
理論値 = 現在スコア + (最大強化値 × 残り強化回数)
達成率 = 現在スコア / 理論値 × 100
```

---

## 6. 再構築更新率計算機能

### 概要
再構築を行った場合に現在より良い聖遺物になる確率を計算します。

### ユーザーストーリー
> ユーザーとして、再構築したら本当に良くなるのか、確率的に判断したい。

### 機能要件

#### 6.1 確率計算
- サブステータスの出現確率
- 強化値の確率分布
- 現在より高スコアになる確率

#### 6.2 再構築タイプ別計算

##### 再構築（通常）
- 希望するサブオプション2種を指定（必須）
- 初期3オプション：+4の状態から+20まで4回振り直し
- 初期4オプション：+0の状態から+20まで5回振り直し
- **最低保証**：希望したサブオプションは合計2回強化
  - +16時点で希望サブオプションが1度も強化されていない → 強制的に希望サブオプションの**どちらか**が強化
  - +20時点で希望サブオプションが合計1回しか強化されていない → 強制的に希望サブオプションの**どちらか**が強化

##### 上級再構築
- 基本仕様は再構築と同じ
- **最低保証**：希望したサブオプションは合計3回強化

##### 絶対再構築
- 基本仕様は再構築と同じ
- **最低保証**：希望したサブオプションは合計4回強化

### UI/UX要件

#### レイアウト
```
┌─────────────────────────────────┐
│  再構築シミュレーション            │
├─────────────────────────────────┤
│  現在スコア: 45.7                │
│                                 │
│  📊 再構築タイプ                 │
│  ┌─────────────────────────┐   │
│  │ 再構築         32.5% ↑   │   │
│  │ 上級再構築     48.3% ↑   │   │
│  │ 絶対再構築     100%  ↑   │   │
│  └─────────────────────────┘   │
│                                 │
│  期待値スコア: 52.3              │
└─────────────────────────────────┘
```

---

## 7. 部位別ランク付け機能

### 概要
同一部位の聖遺物を比較し、ランク付けを行います。

### ユーザーストーリー
> ユーザーとして、自分の花の中でどれが一番良いのか、客観的に知りたい。

### 機能要件

#### 7.1 ランク判定
- 同一部位でスコアを比較
- スコア基準に基づきランクを付与（SS/S/A/B/C）
- 部位別の評価基準を適用

#### 7.2 ランク基準

##### 基本基準（花・羽・杯）
| ランク | スコア範囲 | 評価 |
|--------|-----------|------|
| **SS** | 50.0+ | 最高級 |
| **S** | 45.0 - 49.9 | 優秀 |
| **A** | 40.0 - 44.9 | 良好 |
| **B** | 30.0 - 39.9 | 普通 |
| **C** | 〜 29.9 | 要改善 |

##### 砂（時計）の基準（評価が5.0寛容）
| ランク | スコア範囲 | 評価 |
|--------|-----------|------|
| **SS** | 45.0+ | 最高級 |
| **S** | 40.0 - 44.9 | 優秀 |
| **A** | 35.0 - 39.9 | 良好 |
| **B** | 25.0 - 34.9 | 普通 |
| **C** | 〜 24.9 | 要改善 |

##### 冠の基準（評価が10.0寛容）
| ランク | スコア範囲 | 評価 |
|--------|-----------|------|
| **SS** | 40.0+ | 最高級 |
| **S** | 35.0 - 39.9 | 優秀 |
| **A** | 30.0 - 34.9 | 良好 |
| **B** | 20.0 - 29.9 | 普通 |
| **C** | 〜 19.9 | 要改善 |

**理由**: 
- **砂（時計）**: 攻撃力%・防御力%・HP%など、花・羽ではサブオプションとして評価されやすいステータスがメインオプションとして採用されるケースが多いため、サブオプションのスコアが伸びにくい
- **冠**: 会心率・会心ダメージといった高評価ステータスがメインオプションとして採用されるため、サブオプションで会心系を両方確保できない場合が多く、特にスコアが増えづらい（会心系1種のみの場合、スコア計算の重み付けが大幅に減少）

---

## 8. 再構築推奨機能

### 概要
所持している聖遺物の中で、どれを再構築すべきか推奨します。

### ユーザーストーリー
> ユーザーとして、どの聖遺物を再構築すれば効率的か教えてほしい。

### 機能要件

#### 8.1 優先度計算
- 更新率が高い
- 現在スコアが低い
- 部位のバランス

---

## 9. データ保存機能

### 概要
ユーザーの聖遺物データをローカルに保存し、再訪問時に読み込みます。

### ユーザーストーリー
> ユーザーとして、毎回UIDを入力せずに、前回のデータをすぐに見たい。

### 機能要件

#### 9.1 自動保存
- データ取得後、自動的にLocalStorageに保存
- 最終更新日時を記録

#### 9.2 インポート/エクスポート
- JSON形式でエクスポート
- ファイルからインポート

---

## 📝 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-10-12 | 初版作成 |
